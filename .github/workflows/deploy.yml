name: Build & Deploy to Azure Web App (Container)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  ACR_NAME: coursepredacr123
  IMAGE_NAME: courseprediction
  WEBAPP_NAME: coursepred-webapp-xyz
  RESOURCE_GROUP: predictioncourse_group

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        run: az acr login --name $ACR_NAME

      - name: Build & Push image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:latest .
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:latest

      # ⬇️ Récupère les identifiants ACR (admin doit être activé sur l'ACR)
      - name: Get ACR credentials
        id: acrcreds
        run: |
          USER=$(az acr credential show -n $ACR_NAME --query username -o tsv)
          PASS=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)
          echo "USER=$USER"   >> $GITHUB_OUTPUT
          echo "PASS=$PASS"   >> $GITHUB_OUTPUT

      # ⬇️ Configure la Web App pour tirer l'image depuis l'ACR (nouvelles options)
      - name: Configure Web App container
        run: |
          az webapp config container set \
            -g $RESOURCE_GROUP -n $WEBAPP_NAME \
            --container-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
            --container-registry-url https://$ACR_NAME.azurecr.io \
            --container-registry-user ${{ steps.acrcreds.outputs.USER }} \
            --container-registry-password ${{ steps.acrcreds.outputs.PASS }}

      - name: Set App Settings
        run: |
          az webapp config appsettings set -g $RESOURCE_GROUP -n $WEBAPP_NAME --settings \
            WEBSITES_PORT=8501 \
            USE_AZURE_MLFLOW=1 \
            MLFLOW_TRACKING_URI="azureml://canadacentral.api.azureml.ms/mlflow/v1.0/subscriptions/b115f392-8b15-499a-a548-edd84815dbcb/resourceGroups/predictioncourse_group/providers/Microsoft.MachineLearningServices/workspaces/courseapied-ws"

      - name: Restart Web App
        run: |
          az webapp restart -g $RESOURCE_GROUP -n $WEBAPP_NAME